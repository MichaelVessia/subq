name: Release

on:
  workflow_dispatch:
    inputs:
      package:
        description: "Package to release"
        required: true
        type: choice
        options:
          - cli
          - tui
      bump:
        description: "Version bump"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release-cli:
    if: inputs.package == 'cli'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Typecheck
        run: bun run typecheck

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun run test

      - name: Bump version
        id: version
        run: |
          cd packages/cli
          CURRENT=$(jq -r .version package.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          jq --arg v "$NEW" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "Bumped $CURRENT → $NEW"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/cli/package.json
          git commit -m "chore(cli): release v${{ steps.version.outputs.version }}"
          git push

      - name: Create tag
        run: |
          git tag "cli-v${{ steps.version.outputs.version }}"
          git push origin "cli-v${{ steps.version.outputs.version }}"

      - name: Build all targets
        run: |
          mkdir -p dist
          bun build packages/cli/src/main.ts --compile --target=bun-linux-x64 --outfile dist/subq-cli-linux-x64
          bun build packages/cli/src/main.ts --compile --target=bun-linux-arm64 --outfile dist/subq-cli-linux-arm64
          bun build packages/cli/src/main.ts --compile --target=bun-darwin-x64 --outfile dist/subq-cli-darwin-x64
          bun build packages/cli/src/main.ts --compile --target=bun-darwin-arm64 --outfile dist/subq-cli-darwin-arm64

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cli-v${{ steps.version.outputs.version }}
          files: dist/*
          generate_release_notes: true

      - name: Update cli-latest tag
        run: |
          git tag -f cli-latest
          git push -f origin cli-latest

      - name: Update Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          SHA_LINUX_X64=$(grep 'subq-cli-linux-x64$' dist/checksums.txt | cut -d' ' -f1)
          SHA_LINUX_ARM64=$(grep 'subq-cli-linux-arm64$' dist/checksums.txt | cut -d' ' -f1)
          SHA_DARWIN_X64=$(grep 'subq-cli-darwin-x64$' dist/checksums.txt | cut -d' ' -f1)
          SHA_DARWIN_ARM64=$(grep 'subq-cli-darwin-arm64$' dist/checksums.txt | cut -d' ' -f1)

          cat > subq-cli.rb << EOF
          class SubqCli < Formula
            desc "CLI for SubQ health tracking"
            homepage "https://github.com/MichaelVessia/subq"
            version "${VERSION}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/MichaelVessia/subq/releases/download/cli-v${VERSION}/subq-cli-darwin-arm64"
                sha256 "${SHA_DARWIN_ARM64}"
              end
              on_intel do
                url "https://github.com/MichaelVessia/subq/releases/download/cli-v${VERSION}/subq-cli-darwin-x64"
                sha256 "${SHA_DARWIN_X64}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/MichaelVessia/subq/releases/download/cli-v${VERSION}/subq-cli-linux-arm64"
                sha256 "${SHA_LINUX_ARM64}"
              end
              on_intel do
                url "https://github.com/MichaelVessia/subq/releases/download/cli-v${VERSION}/subq-cli-linux-x64"
                sha256 "${SHA_LINUX_X64}"
              end
            end

            def install
              if OS.mac?
                bin.install "subq-cli-darwin-#{Hardware::CPU.arm? ? "arm64" : "x64"}" => "subq-cli"
              else
                bin.install "subq-cli-linux-#{Hardware::CPU.arm? ? "arm64" : "x64"}" => "subq-cli"
              end
            end

            test do
              assert_match "subq", shell_output("#{bin}/subq-cli --help")
            end
          end
          EOF

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/MichaelVessia/homebrew-tap.git tap
          cp subq-cli.rb tap/Formula/
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/subq-cli.rb
          git commit -m "Update subq-cli to ${VERSION}"
          git push

  release-tui:
    if: inputs.package == 'tui'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - run: bun install

      - name: Typecheck
        run: bun run typecheck

      - name: Lint
        run: bun run lint

      - name: Test
        run: bun run test

      - name: Bump version
        id: version
        run: |
          cd packages/tui
          CURRENT=$(jq -r .version package.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW="${MAJOR}.${MINOR}.${PATCH}"
          jq --arg v "$NEW" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "Bumped $CURRENT → $NEW"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/tui/package.json
          git commit -m "chore(tui): release v${{ steps.version.outputs.version }}"
          git push

      - name: Create tag
        run: |
          git tag "tui-v${{ steps.version.outputs.version }}"
          git push origin "tui-v${{ steps.version.outputs.version }}"

      - name: Build Linux x64
        run: |
          mkdir -p dist
          bun build packages/tui/src/main.tsx --compile --target=bun-linux-x64 --outfile dist/subq-linux-x64

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: tui-v${{ steps.version.outputs.version }}
          files: dist/*
          generate_release_notes: true
          body: |
            ## TUI Release

            **Note:** Only Linux x64 binaries are available due to native dependencies in @opentui/core.

            For other platforms, run from source:
            ```bash
            git clone https://github.com/MichaelVessia/subq.git
            cd subq
            bun install
            bun run packages/tui/src/main.tsx
            ```

      - name: Update tui-latest tag
        run: |
          git tag -f tui-latest
          git push -f origin tui-latest

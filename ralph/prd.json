{
  "project": "subq",
  "description": "Weight tracking application with Effect-based API and React frontend",
  "version": "1.0.0",
  "created_at": "2026-01-14",
  "updated_at": "2026-01-14",
  "technology": {
    "language": "TypeScript",
    "runtime": "Bun",
    "backend": {
      "framework": "Effect HttpApi",
      "database": "SQLite (drizzle-orm, @effect/sql-sqlite-bun)",
      "auth": "better-auth"
    },
    "frontend": {
      "framework": "React 19",
      "routing": "TanStack Router",
      "state": "Effect Atom (@effect-atom/atom-react)",
      "styling": "Tailwind CSS v4"
    },
    "testing": {
      "unit": "bun test (@codeforbreakfast/bun-test-effect)",
      "e2e": "Playwright"
    }
  },
  "reference_repos": [
    "https://github.com/Effect-TS/effect",
    "https://github.com/TanStack/router",
    "https://github.com/tim-smart/effect-atom"
  ],
  "specs_dir": "specs/",
  "available_specs": [
    {
      "file": "EFFECT_TESTING.md",
      "description": "Core testing patterns: it.effect, it.layer, TestClock, property-based testing"
    },
    {
      "file": "EFFECT_BEST_PRACTICES.md",
      "description": "Core Effect rules: no any, TaggedErrors, Schema patterns, equality"
    }
  ],
  "testing_policy": {
    "mandatory": "EVERY story MUST include tests. A story is NOT complete without passing tests.",
    "verification": "bun run check && bun run test:all",
    "no_exceptions": "Do NOT mark a story as complete if tests are missing or failing."
  },
  "stories": [
    {
      "id": "TEST-1.0",
      "phase": "Layer Pattern",
      "epic": "Test infrastructure",
      "title": "Create makeInitializedTestLayer helper",
      "description": "Create a new helper function in test-db.ts that composes setupTables and clearTables into the layer setup, eliminating the need to call these in every test body. Use Layer.effectDiscard for setup and Layer.fresh for test isolation.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "New makeInitializedTestLayer function in packages/api/tests/helpers/test-db.ts",
        "Function accepts a repo layer and returns layer with setup/teardown composed",
        "Uses Layer.fresh to ensure each test gets clean state",
        "Existing makeTestLayer helper preserved for backward compatibility",
        "At least one test file migrated to validate the pattern works"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/helpers/test-db.ts"
        ],
        "pattern": "Layer.effectDiscard(setupTables.pipe(Effect.andThen(clearTables))).pipe(Layer.provideMerge(repo), Layer.fresh)"
      },
      "status": "complete",
      "estimated_complexity": "medium"
    },
    {
      "id": "TEST-1.1",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate weight-log-repo.test.ts to it.layer pattern",
      "description": "Convert weight-log-repo.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(TestLayer)('test', ...). Remove all yield* setupTables and yield* clearTables calls from test bodies.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "weight-log-repo.test.ts uses it.layer() for all tests",
        "Zero 'yield* setupTables' in test bodies",
        "Zero 'yield* clearTables' in test bodies",
        "Zero '.pipe(Effect.provide(TestLayer))' in test bodies",
        "cd packages/api && bun test tests/weight-log-repo.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/weight-log-repo.test.ts"
        ],
        "pattern": "it.layer(TestLayer)('creates entry', () => Effect.gen(function* () { ... }))"
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.2",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate injection-log-repo.test.ts to it.layer pattern",
      "description": "Convert injection-log-repo.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "injection-log-repo.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/injection-log-repo.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/injection-log-repo.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.3",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate inventory-repo.test.ts to it.layer pattern",
      "description": "Convert inventory-repo.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "inventory-repo.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/inventory-repo.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/inventory-repo.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.4",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate schedule-repo.test.ts to it.layer pattern",
      "description": "Convert schedule-repo.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "schedule-repo.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/schedule-repo.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/schedule-repo.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.5",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate goal-repo.test.ts to it.layer pattern",
      "description": "Convert goal-repo.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "goal-repo.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/goal-repo.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/goal-repo.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.6",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate stats-service.test.ts to it.layer pattern",
      "description": "Convert stats-service.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "stats-service.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/stats-service.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/stats-service.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.7",
      "phase": "Layer Pattern",
      "epic": "Migrate to it.layer",
      "title": "Migrate data-export-service.test.ts to it.layer pattern",
      "description": "Convert data-export-service.test.ts from .pipe(Effect.provide(TestLayer)) pattern to it.layer(). Remove setup/clear boilerplate.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "data-export-service.test.ts uses it.layer() for all tests",
        "Zero setup/clear boilerplate in test bodies",
        "cd packages/api && bun test tests/data-export-service.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/data-export-service.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-1.8",
      "phase": "Layer Pattern",
      "epic": "Cleanup",
      "title": "Remove deprecated makeTestLayer helper",
      "description": "After all test files migrated, remove the old makeTestLayer helper and verify no usages remain. Keep only makeInitializedTestLayer.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "rg 'makeTestLayer' packages/api/ returns 0 matches",
        "Only makeInitializedTestLayer exported from test-db.ts",
        "cd packages/api && bun test passes all tests"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/helpers/test-db.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-2.0",
      "phase": "Property Testing",
      "epic": "Add property-based tests",
      "title": "Create property tests for branded types",
      "description": "Add property-based tests using it.effect.prop for branded type validation. Test that Weight, Limit, Offset, and other branded types properly validate their constraints.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "New file packages/api/tests/property-tests.test.ts created",
        "Property test for Weight (positive number constraint)",
        "Property test for Limit (positive integer constraint)",
        "Property test for Offset (non-negative integer constraint)",
        "cd packages/api && bun test tests/property-tests.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/property-tests.test.ts"
        ],
        "pattern": "it.effect.prop('constraint name', [Schema.Number.pipe(Schema.positive())], ([value]) => ...)"
      },
      "status": "complete",
      "estimated_complexity": "medium"
    },
    {
      "id": "TEST-2.1",
      "phase": "Property Testing",
      "epic": "Add property-based tests",
      "title": "Add property tests for frequency conversion",
      "description": "Add property-based tests for the frequencyToDays function used in schedule calculations. Verify conversion is correct for all frequency types.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "Property test validates frequencyToDays returns positive integers",
        "Tests all frequency variants: daily, every_3_days, weekly, every_2_weeks, monthly",
        "cd packages/api && bun test tests/property-tests.test.ts passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/property-tests.test.ts"
        ],
        "pattern": "Test with Schema.Literal for enum values, verify output > 0"
      },
      "status": "complete",
      "estimated_complexity": "small"
    },
    {
      "id": "TEST-3.0",
      "phase": "TestClock",
      "epic": "Deterministic time testing",
      "title": "Refactor schedule-rpc-handlers to use TestClock",
      "description": "Replace setSystemTime() usage in schedule-rpc-handlers.test.ts with Effect TestClock pattern. Use fork + TestClock.adjust for time-dependent tests.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "Zero setSystemTime() calls in schedule-rpc-handlers.test.ts",
        "Uses TestClock.adjust or TestClock.setTime pattern",
        "Time-dependent tests use fork + join pattern",
        "cd packages/api && bun test tests/schedule-rpc-handlers.test.ts passes",
        "Tests are deterministic (run multiple times, same results)"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/schedule-rpc-handlers.test.ts"
        ],
        "pattern": "const fiber = yield* Effect.fork(effect); yield* TestClock.setTime(time); yield* Fiber.join(fiber)"
      },
      "status": "complete",
      "estimated_complexity": "medium"
    },
    {
      "id": "TEST-4.0",
      "phase": "Verification",
      "epic": "Full compliance check",
      "title": "Verify all tests comply with EFFECT_TESTING.md",
      "description": "Final verification pass. Run comprehensive checks to ensure all tests follow the patterns in EFFECT_TESTING.md.",
      "specs": [
        "EFFECT_TESTING.md"
      ],
      "acceptance_criteria": [
        "rg 'setupTables' packages/api/tests/*.test.ts returns 0 matches (only in helpers)",
        "rg 'clearTables' packages/api/tests/*.test.ts returns 0 matches (only in helpers)",
        "rg '\\.pipe\\(Effect\\.provide' packages/api/tests/*.test.ts returns 0 matches",
        "rg 'setSystemTime' packages/api/tests/ returns 0 matches",
        "cd packages/api && bun test passes all tests",
        "bun run check passes"
      ],
      "technical_details": {
        "files": [
          "packages/api/tests/**/*.test.ts"
        ]
      },
      "status": "complete",
      "estimated_complexity": "small"
    }
  ]
}
